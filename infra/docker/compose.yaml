# AgentCompany Docker Compose Configuration
# Workspace環境 + Ollama AI基盤

services:
  # ============================================
  # Ollama - ローカルLLM実行基盤
  # ============================================
  ollama:
    image: ollama/ollama:latest
    container_name: agentcompany-ollama
    
    # GPUを使用する場合（NVIDIA）
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu]
    
    # ボリューム（モデルの永続化）
    volumes:
      - ollama-data:/root/.ollama
    
    # ポート公開
    ports:
      - "11434:11434"
    
    # ネットワーク
    networks:
      - workspace-net
    
    # リソース制限（CPU実行時）
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G
        reservations:
          cpus: '1'
          memory: 2G
    
    # ヘルスチェック（ollama cliを使用）
    healthcheck:
      test: ["CMD", "ollama", "list"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ============================================
  # Workspace - 開発・実行環境
  # ============================================
  workspace:
    build:
      context: ./images/base
      dockerfile: Dockerfile
    container_name: agentcompany-workspace
    
    # Ollamaが起動してから開始
    depends_on:
      ollama:
        condition: service_healthy

    # ボリュームマウント
    volumes:
      # プロジェクトファイル（読み書き可能）
      - ../..:/workspace:rw
      # ログディレクトリ
      - ../../runtime/logs:/workspace/runtime/logs:rw
      # allowlistファイル（読み取り専用）
      - ../../tools/installers/allowlist:/usr/local/agentcompany/installers/allowlist:ro

    # 作業ディレクトリ
    working_dir: /workspace

    # 非rootユーザーで実行
    user: agent

    # 環境変数
    environment:
      - NODE_ENV=development
      - INSTALL_LOG_DIR=/workspace/runtime/logs/install
      - ALLOWLIST_DIR=/usr/local/agentcompany/installers/allowlist
      # Ollama接続設定（コンテナ間通信）
      - OLLAMA_HOST=http://ollama:11434

    # ネットワーク設定
    networks:
      - workspace-net

    # セキュリティ設定
    # E2Eテスト時はno-new-privilegesを無効化する必要がある場合があります
    # security_opt:
    #   - no-new-privileges:true

    # リソース制限
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '0.5'
          memory: 512M

    # インタラクティブモード
    stdin_open: true
    tty: true

  # ============================================
  # Worker - ワーカーエージェント実行環境
  # @see Requirement 5.2: THE Worker_Container SHALL be based on `infra/docker/images/worker/` image
  # @see Requirement 5.7: THE container management SHALL use Container Runtime Abstraction
  # ============================================
  worker:
    build:
      context: ./images/worker
      dockerfile: Dockerfile
    # コンテナ名はworker-container.tsで動的に生成されるため、ここでは設定しない
    # container_name: agentcompany-worker
    
    # プロファイルを使用して、明示的に起動する場合のみ起動
    profiles:
      - worker
    
    # 環境変数（実行時に上書き）
    environment:
      - WORKER_ID=${WORKER_ID:-worker-default}
      - RUN_ID=${RUN_ID:-}
      - GIT_REPO_URL=${GIT_REPO_URL:-}
      - GIT_BRANCH=${GIT_BRANCH:-main}
      - GIT_TOKEN=${GIT_TOKEN:-}
      - WORKSPACE_PATH=/workspace
      # Ollama接続設定（Agent_Bus経由で通信する場合は不要）
      # - OLLAMA_HOST=http://ollama:11434
    
    # ボリュームマウント
    # 注意: /workspaceはコンテナ内にcloneされるため、ホストからマウントしない
    # @see Requirement 5.3: THE Worker_Container SHALL clone the repository into container-local `/workspace`
    volumes:
      # 結果出力ディレクトリ（読み取り専用）
      # @see Requirement 5.4: Shared read-only: `runtime/runs/<run-id>/` for result collection only
      - ../../runtime/runs:/results:ro
    
    # 作業ディレクトリ
    working_dir: /workspace
    
    # 非rootユーザーで実行
    user: agent
    
    # ネットワーク設定
    # @see Requirement 5.4: Network: No inter-container communication except via Agent_Bus
    # デフォルトはネットワーク隔離（none）だが、開発時はworkspace-netに接続可能
    # 本番環境ではworker-container.tsがnetworkMode='none'で起動する
    networks:
      - workspace-net
    
    # セキュリティ設定
    # @see Requirement 5.4: THE Worker_Container SHALL be isolated
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    
    # リソース制限
    # @see Requirement 5.6: THE Worker_Container SHALL have configurable resource limits (CPU, memory)
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '0.5'
          memory: 512M
    
    # プロセス数制限
    pids_limit: 256
    
    # 読み取り専用ルートファイルシステム（オプション）
    # read_only: true
    # tmpfs:
    #   - /tmp:rw,noexec,nosuid,size=256m
    #   - /var/tmp:rw,noexec,nosuid,size=256m

# ============================================
# ボリューム定義
# ============================================
volumes:
  # Ollamaモデルの永続化
  ollama-data:
    driver: local

# ============================================
# ネットワーク定義
# ============================================
networks:
  workspace-net:
    driver: bridge
    # 外部ネットワークへのアクセスを制限（必要に応じて設定）
    # internal: true
